#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Craft CMS MCP Server
 *
 * This script bootstraps Craft CMS and runs an MCP server that exposes
 * Craft functionality as tools for AI assistants.
 *
 * Usage (from Craft root):
 *   php plugins/craft-mcp/bin/mcp-server
 *
 * Usage with DDEV:
 *   ddev exec php plugins/craft-mcp/bin/mcp-server
 */

// Find Craft's base path by looking for bootstrap.php
$basePath = null;
$currentDir = __DIR__;

// Walk up the directory tree to find Craft's root
for ($i = 0; $i < 10; $i++) {
    $currentDir = dirname($currentDir);
    if (file_exists($currentDir . '/bootstrap.php') && file_exists($currentDir . '/craft')) {
        $basePath = $currentDir;
        break;
    }
}

if ($basePath === null) {
    fwrite(STDERR, "Error: Could not find Craft CMS installation. Run this from within a Craft project.\n");
    exit(1);
}

// Change to Craft root for proper path resolution
chdir($basePath);

// Load Craft's bootstrap (includes Composer autoloader)
require_once $basePath . '/bootstrap.php';

// Boot Craft in console mode
define('CRAFT_ENVIRONMENT', getenv('CRAFT_ENVIRONMENT') ?: 'production');

/** @var craft\console\Application $app */
$app = require $basePath . '/vendor/craftcms/cms/bootstrap/console.php';

// Check if MCP is enabled
$plugin = \stimmt\craft\Mcp\Mcp::getInstance();
if ($plugin === null) {
    fwrite(STDERR, "Error: Craft MCP plugin is not installed. Run: php craft plugin/install mcp\n");
    exit(1);
}

if (!\stimmt\craft\Mcp\Mcp::isEnabled()) {
    fwrite(STDERR, "Error: Craft MCP is disabled.\n");
    fwrite(STDERR, "To enable, add to config/mcp.php:\n");
    fwrite(STDERR, "  return ['enabled' => true];\n");
    exit(1);
}

// Verify MCP SDK is available
if (!class_exists(\Mcp\Server::class)) {
    fwrite(STDERR, "Error: MCP SDK not found. Run: composer update\n");
    exit(1);
}

use Mcp\Server;
use Mcp\Server\Transport\StdioTransport;
use stimmt\craft\Mcp\services\ToolRegistry;

// Initialize tool registry and collect all tools
$registry = new ToolRegistry();
$discoveryPaths = $registry->getDiscoveryPaths();
$summary = $registry->getSummary();

// Log registration errors
foreach ($registry->getErrors() as $error) {
    fwrite(STDERR, "Warning: {$error}\n");
}

// Create and configure the MCP server
try {
    $builder = Server::builder()
        ->setServerInfo('Craft CMS MCP Server', '1.0.0');

    // Register discovery paths from all sources
    foreach ($discoveryPaths as $source => $pathInfo) {
        $builder->setDiscovery($pathInfo['path'], $pathInfo['subdirs']);
    }

    $server = $builder->build();

    $transport = new StdioTransport();
    $server->run($transport);
} catch (\Throwable $e) {
    fwrite(STDERR, "Error starting MCP server: " . $e->getMessage() . "\n");
    fwrite(STDERR, $e->getTraceAsString() . "\n");
    exit(1);
}
