#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Craft CMS MCP Server
 *
 * This script bootstraps Craft CMS and runs an MCP server that exposes
 * Craft functionality as tools for AI assistants.
 *
 * Usage (from Craft root):
 *   php vendor/stimmt/craft-mcp/bin/mcp-server
 *
 * Usage with DDEV:
 *   ddev exec php vendor/stimmt/craft-mcp/bin/mcp-server
 */

// Find Craft's base path by looking for bootstrap.php
$basePath = null;
$currentDir = __DIR__;

// Walk up the directory tree to find Craft's root
for ($i = 0; $i < 10; $i++) {
    $currentDir = dirname($currentDir);
    if (file_exists($currentDir . '/bootstrap.php') && file_exists($currentDir . '/craft')) {
        $basePath = $currentDir;
        break;
    }
}

if ($basePath === null) {
    fwrite(STDERR, "Error: Could not find Craft CMS installation. Run this from within a Craft project.\n");
    exit(1);
}

// Change to Craft root for proper path resolution
chdir($basePath);

// Load Craft's bootstrap (includes Composer autoloader)
require_once $basePath . '/bootstrap.php';

// Boot Craft in console mode
define('CRAFT_ENVIRONMENT', getenv('CRAFT_ENVIRONMENT') ?: 'production');

/** @var craft\console\Application $app */
$app = require $basePath . '/vendor/craftcms/cms/bootstrap/console.php';

use stimmt\craft\Mcp\Mcp;
use stimmt\craft\Mcp\services\McpRegistry;
use stimmt\craft\Mcp\services\McpServerFactory;
use stimmt\craft\Mcp\support\SignalHandler;

// Validate plugin is available and enabled
$plugin = Mcp::getInstance();
if ($plugin === null) {
    fwrite(STDERR, "Error: Craft MCP plugin is not installed. Run: php craft plugin/install mcp\n");
    exit(1);
}

if (!Mcp::isEnabled()) {
    fwrite(STDERR, "Error: Craft MCP is disabled.\n");
    fwrite(STDERR, "To enable, add to config/mcp.php:\n");
    fwrite(STDERR, "  return ['enabled' => true];\n");
    exit(1);
}

// Verify MCP SDK is available
if (!class_exists(\Mcp\Server::class)) {
    fwrite(STDERR, "Error: MCP SDK not found. Run: composer update\n");
    exit(1);
}

// Log any registration errors from registries
foreach (McpRegistry::getAllErrors() as $source => $errors) {
    foreach ($errors as $error) {
        fwrite(STDERR, "Warning [{$source}]: {$error}\n");
    }
}

// Setup signal handling for graceful restart/shutdown
$signalHandler = new SignalHandler();
$signalHandler->register();

// Build and run server with dedicated file logger (separate from Craft logs)
try {
    $logger = McpServerFactory::createFileLogger();
    $factory = new McpServerFactory(logger: $logger);
    $server = $factory->create();
    $transport = $factory->createTransport();

    $server->run($transport);

    // Handle restart if requested via SIGHUP
    if ($signalHandler->shouldRestart()) {
        $signalHandler->restart($argv);
    }
} catch (\Throwable $e) {
    fwrite(STDERR, "Error starting MCP server: " . $e->getMessage() . "\n");
    fwrite(STDERR, $e->getTraceAsString() . "\n");
    exit(1);
}
